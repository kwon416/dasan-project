<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.dasancall.service.impl.MainMapper">

	<!--
		일별 상담 통계 목록 조회
		테이블: TB_STAT_CONSULT
		용도  : 기본 상담 건수 일자별 집계 (레거시)
	-->
	<select id="selectDataList" parameterType="dashboardVO" resultType="egovMap">
		SELECT YYYY, MM, DD, SUM(CNT) AS CNT
		FROM TB_STAT_CONSULT
		GROUP BY YYYY, MM, DD
		ORDER BY YYYY, MM, DD
	</select>

	<!--
		==========================================================
		  대시보드 통합 쿼리
		==========================================================
		■ 컬럼 설명
		  - QTYPE   : 서브쿼리 구분자 (Java에서 switch문으로 분류)
		  - DIM_KEY  : 집계 차원 키 (KEYWORD 또는 GU)
		  - CNT      : SUM(건수)

		■ 서브쿼리 목록 (6~8개, keyword 유무에 따라 동적)
		  ┌─────────────────┬──────────────────────────────────────────┬──────────────────┐
		  │ QTYPE           │ 설명                                     │ 프론트엔드 용도   │
		  ├─────────────────┼──────────────────────────────────────────┼──────────────────┤
		  │ KW_LATEST       │ 키워드별 최신 1개 타임존 건수              │ 급상승 현재값     │
		  │ KW_PREV         │ 키워드별 전일 동 타임존 건수               │ 급상승 전일값     │
		  │ KW_VOLUME       │ 키워드별 최근 4타임존(24h) 합산            │ 빈도 현재값      │
		  │ KW_VOL_PREV     │ 키워드별 전일 4타임존(24h) 합산            │ 빈도 전일값      │
		  │ DIST_LATEST     │ 자치구별 최신 타임존 건수                  │ 지도 색상/바차트  │
		  │ DIST_PREV       │ 자치구별 전일 동 타임존 건수               │ 지도/바차트 증감  │
		  │ KPI_DIST_LATEST │ 자치구별 오늘 건수 (TB_STAT_COMPLAINTS)   │ KPI 카드 총건수  │
		  │ KPI_DIST_PREV   │ 자치구별 어제 건수 (TB_STAT_COMPLAINTS)   │ KPI 카드 증감    │
		  └─────────────────┴──────────────────────────────────────────┴──────────────────┘
		  ※ KPI_DIST_* 는 TB_STAT_COMPLAINTS 테이블에서 항상 조회
		    (오늘 0시~현재시각 / 어제 0시~어제 동시각, HH 컬럼 기준 필터)

		■ 필터 조건
		  - gu      : KW_* 서브쿼리에 적용 (특정 자치구의 키워드만 집계)
		  - keyword : DIST_* 서브쿼리에 적용 (특정 키워드의 자치구별 집계)

		■ 파라미터 목록
		  latestYyyy, latestMm, latestDd, latestTmZn  : 최신 타임존 날짜
		  prevYyyy, prevMm, prevDd, prevTmZn           : 전일 동 타임존 날짜
		  timeSlots (List<Map>)                        : 최근 4개 타임존 슬롯
		  prevTimeSlots (List<Map>)                    : 전일 4개 타임존 슬롯
		  gu (nullable)                                : 자치구 필터
		  keyword (nullable)                           : 키워드 필터
		  kpiTodayYyyy, kpiTodayMm, kpiTodayDd        : KPI용 오늘 날짜
		  kpiYesterdayYyyy, kpiYesterdayMm, kpiYesterdayDd : KPI용 어제 날짜
		  kpiCurrentHh (int)                           : KPI용 현재 시각 (0~23)

		■ 인덱스
		  CREATE INDEX idx_stat_call_kw   ON TB_STAT_CALL (YYYY, MM, DD, TM_ZN, GU, KEYWORD, CNT);
		  CREATE INDEX idx_stat_call_dist ON TB_STAT_CALL (YYYY, MM, DD, TM_ZN, KEYWORD, GU, CNT);
	-->
	<select id="selectDashboardAll" parameterType="hashmap" resultType="egovMap">
		WITH TB_STAT_CALL_ONLY_GU AS (
			SELECT *
			FROM TB_STAT_CALL
			WHERE GU IN ('종로구', '중구', '용산구', '성동구', '광진구', '동대문구', '중랑구', '성북구', '강북구', '도봉구', '노원구', '은평구', '서대문구', '마포구', '양천구'
			, '강서구', '구로구', '금천구', '영등포구', '동작구', '관악구', '서초구', '강남구', '송파구', '강동구')
		)
		<!-- ① KW_LATEST: 최신 타임존의 키워드별 민원 건수 (급상승 현재값) -->
		SELECT 'KW_LATEST' AS QTYPE, KEYWORD AS DIM_KEY, SUM(CNT) AS CNT
		FROM TB_STAT_CALL
		WHERE YYYY = #{latestYyyy} AND MM = #{latestMm} AND DD = #{latestDd} AND TM_ZN = #{latestTmZn}
		<if test="gu != null and gu != ''">AND GU = #{gu}</if>
		GROUP BY KEYWORD

		UNION ALL

		<!-- ② KW_PREV: 전일 동 타임존의 키워드별 민원 건수 (급상승 비교 기준) -->
		SELECT 'KW_PREV', KEYWORD, SUM(CNT)
		FROM TB_STAT_CALL
		WHERE YYYY = #{prevYyyy} AND MM = #{prevMm} AND DD = #{prevDd} AND TM_ZN = #{prevTmZn}
		<if test="gu != null and gu != ''">AND GU = #{gu}</if>
		GROUP BY KEYWORD

		UNION ALL

		<!-- ③ KW_VOLUME: 최근 4개 타임존(24시간) 키워드별 합산 (빈도 현재값) -->
		<!-- foreach로 4개 타임존 슬롯을 OR 조건으로 전개 -->
		SELECT 'KW_VOLUME', KEYWORD, SUM(CNT)
		FROM TB_STAT_CALL
		WHERE (
			<foreach collection="timeSlots" item="slot" separator=" OR ">
				(YYYY = #{slot.yyyy} AND MM = #{slot.mm} AND DD = #{slot.dd} AND TM_ZN = #{slot.tmZn})
			</foreach>
		)
		<if test="gu != null and gu != ''">AND GU = #{gu}</if>
		GROUP BY KEYWORD

		UNION ALL

		<!-- ④ KW_VOL_PREV: 전일 4개 타임존(24시간) 키워드별 합산 (빈도 비교 기준) -->
		SELECT 'KW_VOL_PREV', KEYWORD, SUM(CNT)
		FROM TB_STAT_CALL
		WHERE (
			<foreach collection="prevTimeSlots" item="slot" separator=" OR ">
				(YYYY = #{slot.yyyy} AND MM = #{slot.mm} AND DD = #{slot.dd} AND TM_ZN = #{slot.tmZn})
			</foreach>
		)
		<if test="gu != null and gu != ''">AND GU = #{gu}</if>
		GROUP BY KEYWORD

		UNION ALL

		<!-- ⑤ DIST_LATEST: 최신 타임존의 자치구별 민원 건수 (지도 색상 + 바 차트) -->
		SELECT 'DIST_LATEST', GU, SUM(CNT)
		FROM TB_STAT_CALL_ONLY_GU
		WHERE YYYY = #{latestYyyy} AND MM = #{latestMm} AND DD = #{latestDd} AND TM_ZN = #{latestTmZn}
		<if test="keyword != null and keyword != ''">AND KEYWORD = #{keyword}</if>
		GROUP BY GU

		UNION ALL

		<!-- ⑥ DIST_PREV: 전일 동 타임존의 자치구별 민원 건수 (지도/바차트 전일 대비 증감) -->
		SELECT 'DIST_PREV', GU, SUM(CNT)
		FROM TB_STAT_CALL_ONLY_GU
		WHERE YYYY = #{prevYyyy} AND MM = #{prevMm} AND DD = #{prevDd} AND TM_ZN = #{prevTmZn}
		<if test="keyword != null and keyword != ''">AND KEYWORD = #{keyword}</if>
		GROUP BY GU

		UNION ALL

		<!--
			⑦ KPI_DIST_LATEST: KPI 카드용 오늘 자치구별 민원 건수
			TB_STAT_COMPLAINTS
			오늘 0시 ~ 현재 시각까지 집계
		-->
		SELECT 'KPI_DIST_LATEST', GU, SUM(CNT)
		FROM TB_STAT_COMPLAINTS
		WHERE YYYY = #{kpiTodayYyyy} AND MM = #{kpiTodayMm} AND DD = #{kpiTodayDd}
		  AND HH &lt;= #{kpiCurrentHh}
		GROUP BY GU

		UNION ALL

		<!--
			⑧ KPI_DIST_PREV: KPI 카드용 어제 자치구별 민원 건수
			어제 0시 ~ 어제 동일 시각까지 집계 (동일 시간대 비교)
		-->
		SELECT 'KPI_DIST_PREV', GU, SUM(CNT)
		FROM TB_STAT_COMPLAINTS
		WHERE YYYY = #{kpiYesterdayYyyy} AND MM = #{kpiYesterdayMm} AND DD = #{kpiYesterdayDd}
		  AND HH &lt;= #{kpiCurrentHh}
		GROUP BY GU
	</select>

</mapper>
