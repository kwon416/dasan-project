<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="DasanDashboardDAO">

	<resultMap id="dashboardStatsMap" type="egovframework.dasan.dashboard.service.DashboardStatsVO">
		<result property="totalCount" column="total_count"/>
		<result property="realtimeCount" column="realtime_count"/>
		<result property="batchCount" column="batch_count"/>
		<result property="latestUpdateDt" column="latest_update_dt"/>
		<result property="dataCollectionBgnDe" column="data_collection_bgn_de"/>
		<result property="dataCollectionEndDe" column="data_collection_end_de"/>
		<result property="dataSizeMb" column="data_size_mb"/>
		<result property="todayCount" column="today_count"/>
		<result property="weekCount" column="week_count"/>
		<result property="monthCount" column="month_count"/>
	</resultMap>

	<!-- 대시보드 통계 정보 조회 -->
	<select id="selectDashboardStats" resultMap="dashboardStatsMap">
		SELECT
			/* 실시간 데이터 건수 */
			(SELECT IFNULL(COUNT(*), 0) FROM tb_real_time) AS realtime_count,

			/* 배치 데이터 건수 */
			(SELECT IFNULL(COUNT(*), 0) FROM tb_bach_consultation) AS batch_count,

			/* 전체 건수 */
			(
				(SELECT IFNULL(COUNT(*), 0) FROM tb_real_time) +
				(SELECT IFNULL(COUNT(*), 0) FROM tb_bach_consultation)
			) AS total_count,

			/* 최신 업데이트 일시 - 실시간 테이블의 최신 데이터 기준 */
			(
				SELECT
					CONCAT(
						IFNULL(MAX(yy), '0000'), '-',
						LPAD(IFNULL(MAX(mm), '01'), 2, '0'), '-',
						LPAD(IFNULL(MAX(dd), '01'), 2, '0'), ' ',
						LPAD(IFNULL(MAX(hh), '00'), 2, '0'), ':00:00'
					)
				FROM tb_real_time
			) AS latest_update_dt,

			/* 데이터 수집 시작일 */
			(
				SELECT
					CONCAT(
						IFNULL(MIN(yy), '0000'), '-',
						LPAD(IFNULL(MIN(mm), '01'), 2, '0'), '-',
						LPAD(IFNULL(MIN(dd), '01'), 2, '0')
					)
				FROM (
					SELECT yy, mm, dd FROM tb_real_time
					UNION ALL
					SELECT yy, mm, dd FROM tb_bach_consultation
				) AS all_data
			) AS data_collection_bgn_de,

			/* 데이터 수집 종료일 */
			(
				SELECT
					CONCAT(
						IFNULL(MAX(yy), '0000'), '-',
						LPAD(IFNULL(MAX(mm), '01'), 2, '0'), '-',
						LPAD(IFNULL(MAX(dd), '01'), 2, '0')
					)
				FROM (
					SELECT yy, mm, dd FROM tb_real_time
					UNION ALL
					SELECT yy, mm, dd FROM tb_bach_consultation
				) AS all_data
			) AS data_collection_end_de,

			/* 데이터 크기 (MB) - 대략적인 계산 */
			ROUND(
				(
					(SELECT IFNULL(COUNT(*), 0) FROM tb_real_time) +
					(SELECT IFNULL(COUNT(*), 0) FROM tb_bach_consultation)
				) * 0.001, 2
			) AS data_size_mb,

			/* 오늘 등록된 건수 */
			(
				SELECT IFNULL(COUNT(*), 0)
				FROM tb_real_time
				WHERE yy = YEAR(CURDATE())
					AND mm = LPAD(MONTH(CURDATE()), 2, '0')
					AND dd = LPAD(DAY(CURDATE()), 2, '0')
			) AS today_count,

			/* 이번 주 등록된 건수 (월요일 ~ 오늘) */
			(
				SELECT IFNULL(COUNT(*), 0)
				FROM tb_real_time
				WHERE STR_TO_DATE(CONCAT(yy, '-', mm, '-', dd), '%Y-%m-%d')
					BETWEEN DATE_SUB(CURDATE(), INTERVAL WEEKDAY(CURDATE()) DAY)
					AND CURDATE()
			) AS week_count,

			/* 이번 달 등록된 건수 */
			(
				SELECT IFNULL(COUNT(*), 0)
				FROM tb_real_time
				WHERE yy = YEAR(CURDATE())
					AND mm = LPAD(MONTH(CURDATE()), 2, '0')
			) AS month_count
		FROM DUAL
	</select>

</mapper>
